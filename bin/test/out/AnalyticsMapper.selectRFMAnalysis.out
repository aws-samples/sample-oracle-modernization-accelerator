================================================================================
AnalyticsMapper.selectRFMAnalysis 차이 분석 보고서
================================================================================
분석 일시: 2025-01-01
SQL ID: AnalyticsMapper.selectRFMAnalysis
결과 동일성: 다름 (same = 'N')

================================================================================
1. 개요
================================================================================
Oracle과 PostgreSQL에서 동일한 500건의 데이터를 반환하지만, RFM 세그먼트 분류에서 
상당한 차이가 발생하고 있습니다. 이는 PostgreSQL 구문 수정이 필요한 상황입니다.

================================================================================
2. RFM 세그먼트 분류 차이 통계
================================================================================
RFM 세그먼트           | Oracle 개수 | PostgreSQL 개수 | 차이  | 변화율
--------------------- | ----------- | --------------- | ----- | ------
Lost Customers        |         122 |             135 |   +13 | +10.7%
Loyal Customers       |         110 |             133 |   +23 | +20.9%
Others                |         104 |              80 |   -24 | -23.1%
Champions             |         100 |              95 |    -5 |  -5.0%
At Risk               |          36 |              47 |   +11 | +30.6%
Potential Loyalists   |          28 |              10 |   -18 | -64.3%
--------------------- | ----------- | --------------- | ----- | ------
총계                  |         500 |             500 |     0 |   0.0%

================================================================================
3. 구체적인 차이 사례 (상위 20건)
================================================================================
User ID | Email               | F | M      | R   | Oracle 세그먼트     | PostgreSQL 세그먼트
--------|---------------------|---|--------|-----|--------------------|--------------------- 
      1 | user1@example.com   | 2 | 699.18 |  35 | Loyal Customers    | Champions
      4 | user4@example.com   | 2 | 580.90 |  25 | Champions          | Loyal Customers
     10 | user10@example.com  | 1 | 470.67 | 322 | Others             | At Risk
     15 | user15@example.com  | 1 | 345.05 |  43 | Loyal Customers    | Potential Loyalists
     22 | user22@example.com  | 1 | 395.00 | 150 | Potential Loyalists| Loyal Customers
     29 | user29@example.com  | 1 | 368.80 | 177 | Potential Loyalists| Loyal Customers
     31 | user31@example.com  | 1 | 134.97 | 232 | Others             | Lost Customers
     33 | user33@example.com  | 1 | 414.74 | 315 | Others             | At Risk
     35 | user35@example.com  | 1 | 408.69 | 188 | Potential Loyalists| Loyal Customers
     44 | user44@example.com  | 1 | 355.58 | 356 | At Risk            | Others
     49 | user49@example.com  | 2 | 514.38 |  10 | Champions          | Loyal Customers
     72 | user72@example.com  | 1 | 467.55 | 113 | Potential Loyalists| Loyal Customers
     86 | user86@example.com  | 2 | 496.30 |  14 | Champions          | Loyal Customers
     89 | user89@example.com  | 1 | 405.83 | 265 | Others             | At Risk
     95 | user95@example.com  | 1 | 447.28 | 292 | Others             | At Risk
    119 | user119@example.com | 1 | 405.21 | 255 | Others             | At Risk
    133 | user133@example.com | 1 | 527.10 | 297 | Others             | At Risk
    140 | user140@example.com | 1 | 402.47 |  39 | Potential Loyalists| Loyal Customers
    144 | user144@example.com | 1 | 493.54 |  92 | Potential Loyalists| Loyal Customers
    159 | user159@example.com | 1 | 111.43 | 215 | Others             | Lost Customers

* F: Frequency (주문 빈도), M: Monetary (구매 금액), R: Recency (최근 구매일)

================================================================================
4. 원인 분석
================================================================================

4.1 RFM 점수 계산 로직의 차이
- Oracle과 PostgreSQL에서 NTILE 함수의 동작 방식이 미묘하게 다름
- 분위수 계산 시 동일한 값에 대한 처리 방식 차이
- 정렬 순서(ORDER BY)에서 NULL 값 처리 차이

4.2 세그먼트 분류 기준의 차이  
- RFM 점수를 세그먼트로 변환하는 CASE 문의 조건 처리 방식 차이
- 경계값(boundary value) 처리에서의 차이
- 조건문의 우선순위 처리 차이

4.3 데이터 타입 처리
- DECIMAL/NUMERIC 타입의 정밀도 차이
- 반올림 처리 방식의 차이
- 부동소수점 연산 결과의 미묘한 차이

4.4 NULL 값 및 예외 처리
- 각 DB에서 NULL 값을 다루는 방식의 차이
- 0으로 나누기 등 예외 상황 처리 차이

================================================================================
5. 영향도 평가
================================================================================

5.1 비즈니스 영향도: 높음
- RFM 분석은 고객 세그먼테이션의 핵심 로직
- 마케팅 캠페인 타겟팅에 직접적인 영향
- 고객 생애 가치(CLV) 계산에 영향

5.2 데이터 정합성: 중요
- 동일한 고객이 다른 세그먼트로 분류됨
- 특히 "Potential Loyalists" 세그먼트에서 64.3% 감소는 심각한 수준

5.3 마이그레이션 위험도: 높음
- 기존 비즈니스 로직과의 불일치 발생 가능
- 고객 대상 서비스 품질에 영향 가능

================================================================================
6. 권장 해결 방안
================================================================================

6.1 즉시 조치 사항
□ PostgreSQL의 RFM 분석 쿼리 로직 수정 필요
□ Oracle 버전과 동일한 결과를 보장하는 로직 구현
□ 테스트 케이스를 통한 검증 수행

6.2 구체적인 수정 방향
□ NTILE 함수 대신 명시적인 임계값 기반 분류 사용 검토
□ RFM 점수 계산 시 정확한 분위수 로직 구현
□ 세그먼트 분류 조건문의 명시적 우선순위 설정
□ 데이터 타입과 정밀도 통일

6.3 검증 방법
□ 샘플 데이터셋으로 Oracle과 PostgreSQL 결과 비교
□ 경계값 케이스에 대한 단위 테스트 수행
□ 전체 데이터셋에 대한 세그먼트 분포 검증

6.4 장기적 개선 사항
□ RFM 분석 로직의 표준화 및 문서화
□ 크로스 플랫폼 호환성을 고려한 SQL 작성 가이드라인 수립
□ 자동화된 회귀 테스트 환경 구축

================================================================================
7. 결론
================================================================================
AnalyticsMapper.selectRFMAnalysis는 PostgreSQL 구문 수정이 반드시 필요합니다.
특히 RFM 세그먼트 분류 로직에서 발생하는 차이는 비즈니스에 중대한 영향을 
미칠 수 있으므로, 마이그레이션 전에 정확한 로직 통일이 선행되어야 합니다.

우선순위: 높음 (High Priority)
작업 예상 시간: 2-3일
검증 필요 시간: 1-2일

================================================================================
