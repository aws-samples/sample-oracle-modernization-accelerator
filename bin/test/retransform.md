# SQL Conversion Correction Based on SQL Test Conversion Errors

**CRITICAL DATABASE CONNECTION INFO**:
- **Absolutely NO SQLite usage!** 
- **Must use PostgreSQL**: Connect using psql command
- **Connection command**: `psql` (automatically uses environment variables)
- **Table location**: oma.sqllist (PostgreSQL schema)
- **Never use SQLite file (oma_test.db)**

Reference: Apply environment information from $APP_TOOLS_FOLDER/environmentContext.md

**IMPORTANT**: This process requires interactive user input. The system MUST pause and wait for user input at designated points. Do not skip or auto-fill any user input sections.

[$TARGET_DBMS_TYPE Expert Mode]
**Objective**: Perform comprehensive SQL testing and correct SQL conversions for SQLs that do not produce identical results

**Expert mode settings**:
- Utilize expert knowledge for SQL conversion from $SOURCE_DBMS_TYPE to $TARGET_DBMS_TYPE
- Deep understanding of $TARGET_DBMS_TYPE syntax, functions, and data types

---

## 1. Identify Inaccurate Conversion Statements
- Identify items with different results from the latest out/analysis_report_*.md test result file generated by analyze_result.sh execution
- **PostgreSQL connection**: Use `psql` command (automatically recognizes environment variables)
- sqllist table
$ psql
oma=> \d sqllist
                         Table "oma.sqllist"
   Column   |          Type          | Collation | Nullable | Default
------------+------------------------+-----------+----------+---------
 sql_id     | character varying(100) |           | not null |
 sql_type   | character(1)           |           | not null |
 src_path   | text                   |           |          |
 src_stmt   | text                   |           |          |
 src_params | text                   |           |          |
 src_result | text                   |           |          |
 tgt_path   | text                   |           |          |
 tgt_stmt   | text                   |           |          |
 tgt_params | text                   |           |          |
 tgt_result | text                   |           |          |
 same       | character(1)           |           |          |
Indexes:
    "sqllist_pkey" PRIMARY KEY, btree (sql_id)
    "idx_sqllist_same" btree (same)
    "idx_sqllist_sql_type" btree (sql_type)
Check constraints:
    "sqllist_same_check" CHECK (same = ANY (ARRAY['Y'::bpchar, 'N'::bpchar]))
    "sqllist_sql_type_check" CHECK (sql_type = ANY (ARRAY['S'::bpchar, 'I'::bpchar, 'U'::bpchar, 'D'::bpchar, 'P'::bpchar, 'O'::bpchar]))

- **Query example**: `psql -c "SELECT sql_id, length(src_result) as src_result_length, length(tgt_result) as tgt_result_length FROM oma.sqllist WHERE same='N' ORDER BY sql_id"`
- Extract the following information for each error:
  - SQL ID
  - Source and target mapper file names

## 2. Analyze Causes of Different Test Results
- **In PostgreSQL** compare and analyze src_result and tgt_result from oma.sqllist table
- Compare and analyze source mapper and target mapper files
- Find the cause of differences in test results and suggest correction methods

## 3. Target Mapper Correction Process
- Explain specific correction details
- Compare SQL before and after correction
- Review impact of corrections on other parts
- Principles that must be followed during correction:
  1. No SQL structure simplification! Must maintain source structure while converting
  2. Hard-coded modifications are not allowed
  3. Never touch source mapper (Oracle)
  4. Never use regex-based sed changes, AI must directly verify and modify
  5. Do not simplify SQL statements during conversion
  6. Continue corrections until source and target results match completely. No tolerance for even slight errors
  7. When modifying target statements, compare with source statements during modification
  8. Compare and analyze execution result values between source and target as there may be data type or precision differences
- Correction statement verification method: ./run_postgresql.sh [sqllist.tgt_path]
- Request user approval
   ```
   Do you want to execute target mapper SQL conversion? (y/s/q)
   y: Yes, execute conversion
   s: Skip (already converted)
   q: Quit
   >
   ```
**STOP HERE - WAIT FOR USER APPROVAL**

The system must pause and wait for user to enter y, n, s, or q.
Each modification requires explicit user approval.

- After conversion is completed, proceed to next conversion with user confirmation
   ```
   [mapper_name.sql_id] conversion completed. Do you want to execute next statement conversion? (y/n/s/q)
   y: Yes, execute next statement conversion
   n: No, continue with current statement conversion
   s: Skip (already converted)
   q: Quit
   >
   ```

## Precautions

- **Backup required**: Backup original files before all modifications
- **Incremental modification**: Process one error at a time, not multiple errors at once
- **Individual verification**: Immediately verify with individual tests after each file modification
- **Overall verification**: Comprehensive verification with overall tests after multiple file modifications
- **Side effect check**: Monitor for new errors caused by modifications
- **Documentation**: Clearly record modification details and reasons
- **User confirmation**: Proceed with all modifications only after user approval

