package com.test.mybatis;

import java.io.*;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.nio.file.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.concurrent.TimeUnit;

/**
 * sqlplusë¥¼ ì‚¬ìš©í•˜ëŠ” ë°”ì¸ë“œ ë³€ìˆ˜ ìƒì„±ê¸°
 * Oracle DB ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  SQL ë§¤í¼ íŒŒì¼ì˜ ë°”ì¸ë“œ ë³€ìˆ˜ì— ì ì ˆí•œ ê°’ì„ ìƒì„±í•©ë‹ˆë‹¤.
 */
public class SqlPlusBindVariableGenerator {
    
    // Oracle ì—°ê²° ì„¤ì •
    private static final String ORACLE_SVC_USER = System.getenv("ORACLE_SVC_USER");
    private static final String ORACLE_SVC_PASSWORD = System.getenv("ORACLE_SVC_PASSWORD");
    private static final String ORACLE_CONNECT_STRING = System.getenv().getOrDefault("ORACLE_SVC_CONNECT_STRING", 
                                                        System.getenv().getOrDefault("ORACLE_SID", "orcl"));
    private static final String ORACLE_SVC_USER_LIST = System.getenv("ORACLE_SVC_USER_LIST");
    private static final String SOURCE_SQL_MAPPER_FOLDER = System.getenv("SOURCE_SQL_MAPPER_FOLDER");
    
    // Q Chat ê¸°ë°˜ ì§€ëŠ¥í˜• ê°’ ìƒì„± ì‹œìŠ¤í…œ ì„¤ì • (ë¹ ë¥¸ ì‘ë‹µ ìµœì í™”)
    private static final int Q_CHAT_TIMEOUT = Integer.parseInt(System.getenv().getOrDefault("Q_CHAT_TIMEOUT", "5")); // 5ì´ˆë¡œ ë‹¨ì¶•
    private static final int MAX_WORD_LENGTH = Integer.parseInt(System.getenv().getOrDefault("MAX_WORD_LENGTH", "20"));
    private static final int SIMILARITY_THRESHOLD = Integer.parseInt(System.getenv().getOrDefault("SIMILARITY_THRESHOLD", "50"));
    private static final int MAX_SAMPLE_TABLES = Integer.parseInt(System.getenv().getOrDefault("MAX_SAMPLE_TABLES", "3")); // 3ê°œë¡œ ì¶•ì†Œ
    
    // ìµœì†Œí•œì˜ fallback ê°’ë“¤ (Q Chat ì™„ì „ ì‹¤íŒ¨ì‹œì—ë§Œ ì‚¬ìš©)
    private static final String FALLBACK_DATE = "2025-08-23";
    private static final String FALLBACK_TIMESTAMP = "2025-08-23 10:30:00";
    private static final String FALLBACK_YEAR = "2025";
    private static final int FALLBACK_ID = 1;
    private static final int FALLBACK_AMOUNT = 1000;
    private static final int FALLBACK_DAYS = 30;
    private static final int FALLBACK_LIMIT = 10;
    private static final int FALLBACK_OFFSET = 0;
    
    private String connectionString;
    private Map<String, Map<String, Map<String, ColumnInfo>>> dictionary = new HashMap<>();
    private Map<String, BindVariable> bindVariables = new HashMap<>();
    private String primarySchema; // ì²« ë²ˆì§¸ ìŠ¤í‚¤ë§ˆë¥¼ ê¸°ë³¸ ìŠ¤í‚¤ë§ˆë¡œ ì‚¬ìš©
    
    public static void main(String[] args) {
        SqlPlusBindVariableGenerator generator = new SqlPlusBindVariableGenerator();
        try {
            generator.run();
        } catch (Exception e) {
            System.err.println("ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    public void run() throws Exception {
        System.out.println("=== ë°”ì¸ë“œ ë³€ìˆ˜ ìƒì„±ê¸° ì‹œì‘ ===\n");
        
        // 1ë‹¨ê³„: Oracle ì ‘ì†
        step1ConnectOracle();
        
        // 2ë‹¨ê³„: ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘
        step2CollectMetadata();
        
        // 3ë‹¨ê³„: ì„œë¹„ìŠ¤ ìœ ì € í™•ì¸
        step3GetServiceUsers();
        
        // 4ë‹¨ê³„: ë°”ì¸ë“œ ë³€ìˆ˜ ì¶”ì¶œ
        step4ExtractBindVariables();
        
        // 5ë‹¨ê³„: ìë™ ë§¤ì¹­
        step5MatchBindVariables();
        
        // 6ë‹¨ê³„: ìˆ˜ë™ ë§¤ì¹­
        step6ManualMatching();
        
        // 7ë‹¨ê³„: parameters.properties íŒŒì¼ ìƒì„±
        step7GeneratePropertiesFile();
        
        System.out.println("\n=== ë°”ì¸ë“œ ë³€ìˆ˜ ìƒì„±ê¸° ì™„ë£Œ ===");
        System.out.println("ê²°ê³¼ íŒŒì¼:");
        System.out.println("- parameters.properties: ë°”ì¸ë“œ ë³€ìˆ˜=ê°’ í˜•íƒœ");
    }
    
    private void step1ConnectOracle() throws Exception {
        System.out.println("1ë‹¨ê³„: Oracle DB ì ‘ì† í…ŒìŠ¤íŠ¸...");
        
        if (ORACLE_SVC_USER == null || ORACLE_SVC_PASSWORD == null) {
            throw new RuntimeException("Oracle ì ‘ì† ì •ë³´ê°€ í™˜ê²½ë³€ìˆ˜ì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
        
        connectionString = ORACLE_SVC_USER + "/" + ORACLE_SVC_PASSWORD + "@" + ORACLE_CONNECT_STRING;
        
        // sqlplusë¡œ ì ‘ì† í…ŒìŠ¤íŠ¸
        String testResult = executeSqlPlus("SELECT 1 FROM DUAL;");
        if (testResult.contains("1")) {
            System.out.println("âœ“ Oracle DB ì ‘ì† ì„±ê³µ");
        } else {
            throw new RuntimeException("Oracle DB ì ‘ì† ì‹¤íŒ¨");
        }
    }
    
    private String executeSqlPlus(String sql) throws Exception {
        ProcessBuilder pb = new ProcessBuilder("sqlplus", "-S", connectionString);
        Process process = pb.start();
        
        try (PrintWriter writer = new PrintWriter(process.getOutputStream())) {
            writer.println(sql);
            writer.println("EXIT;");
            writer.flush();
        }
        
        StringBuilder output = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
        }
        
        process.waitFor();
        return output.toString();
    }
    
    private void step2CollectMetadata() throws Exception {
        System.out.println("2ë‹¨ê³„: í…Œì´ë¸” ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘ ì¤‘...");
        
        String[] serviceUsers = ORACLE_SVC_USER_LIST != null ? 
            ORACLE_SVC_USER_LIST.split(",") : new String[]{ORACLE_SVC_USER};
        
        StringBuilder userList = new StringBuilder();
        for (int i = 0; i < serviceUsers.length; i++) {
            if (i > 0) userList.append(",");
            userList.append("'").append(serviceUsers[i].trim()).append("'");
        }
        
        String sql = String.format("""
            SET PAGESIZE 0
            SET FEEDBACK OFF
            SET HEADING OFF
            SET LINESIZE 4000
            
            SELECT 
                OWNER || '|' || TABLE_NAME || '|' || COLUMN_NAME || '|' || DATA_TYPE || '|' || 
                CASE 
                    WHEN DATA_TYPE IN ('VARCHAR2', 'CHAR') THEN DATA_LENGTH
                    WHEN DATA_TYPE = 'NUMBER' THEN NVL(DATA_PRECISION, 38)
                    ELSE NULL
                END || '|' || 
                CASE 
                    WHEN DATA_TYPE IN ('VARCHAR2', 'CHAR') THEN NVL(DATA_SCALE, 0)
                    WHEN DATA_TYPE = 'NUMBER' THEN NVL(DATA_SCALE, 0)
                    ELSE NULL
                END
            FROM ALL_TAB_COLUMNS 
            WHERE OWNER IN (%s)
            ORDER BY OWNER, TABLE_NAME, COLUMN_ID;
            """, userList.toString());
        
        String result = executeSqlPlus(sql);
        String[] lines = result.split("\n");
        
        for (String line : lines) {
            if (line.contains("|")) {
                String[] parts = line.split("\\|");
                if (parts.length >= 6) {
                    String owner = parts[0].trim();
                    String tableName = parts[1].trim();
                    String columnName = parts[2].trim();
                    String dataType = parts[3].trim();
                    String lengthStr = parts[4].trim();
                    String scaleStr = parts[5].trim();
                    
                    // ì•ˆì „í•œ ìˆ«ì íŒŒì‹±
                    int dataLength = parseIntSafely(lengthStr, 0);
                    int dataScale = parseIntSafely(scaleStr, 0);
                    
                    // ìƒ˜í”Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    String sampleData = getSampleData(owner, tableName, columnName, dataType);
                    
                    ColumnInfo columnInfo = new ColumnInfo(dataType, dataLength, 0, dataScale, sampleData);
                    
                    dictionary.computeIfAbsent(owner, k -> new HashMap<>())
                             .computeIfAbsent(tableName, k -> new HashMap<>())
                             .put(columnName, columnInfo);
                }
            }
        }
        
        int totalTables = dictionary.values().stream()
            .mapToInt(schema -> schema.size()).sum();
        int totalColumns = dictionary.values().stream()
            .mapToInt(schema -> schema.values().stream()
                .mapToInt(table -> table.size()).sum()).sum();
        
        System.out.printf("âœ“ ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ (%d ìŠ¤í‚¤ë§ˆ, %d í…Œì´ë¸”, %d ì»¬ëŸ¼)%n", 
            dictionary.size(), totalTables, totalColumns);
        
        // ë”•ì…”ë„ˆë¦¬ë¥¼ out í´ë”ì— JSON íŒŒì¼ë¡œ ì €ì¥
        saveDictionaryToFile();
    }
    
    /**
     * ë”•ì…”ë„ˆë¦¬ë¥¼ out í´ë”ì— JSON íŒŒì¼ë¡œ ì €ì¥
     */
    private void saveDictionaryToFile() {
        try {
            // out ë””ë ‰í† ë¦¬ ìƒì„±
            Path outDir = Paths.get("out");
            if (!Files.exists(outDir)) {
                Files.createDirectories(outDir);
            }
            
            // ë”•ì…”ë„ˆë¦¬ë¥¼ JSON í˜•íƒœë¡œ ë³€í™˜
            StringBuilder json = new StringBuilder();
            json.append("{\n");
            json.append("  \"metadata\": {\n");
            json.append("    \"generatedAt\": \"").append(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))).append("\",\n");
            json.append("    \"schemas\": ").append(dictionary.size()).append(",\n");
            json.append("    \"totalTables\": ").append(dictionary.values().stream().mapToInt(schema -> schema.size()).sum()).append(",\n");
            json.append("    \"totalColumns\": ").append(dictionary.values().stream().mapToInt(schema -> schema.values().stream().mapToInt(table -> table.size()).sum()).sum()).append("\n");
            json.append("  },\n");
            json.append("  \"dictionary\": {\n");
            
            boolean firstSchema = true;
            for (Map.Entry<String, Map<String, Map<String, ColumnInfo>>> schemaEntry : dictionary.entrySet()) {
                if (!firstSchema) json.append(",\n");
                firstSchema = false;
                
                String schema = schemaEntry.getKey();
                json.append("    \"").append(schema).append("\": {\n");
                
                boolean firstTable = true;
                for (Map.Entry<String, Map<String, ColumnInfo>> tableEntry : schemaEntry.getValue().entrySet()) {
                    if (!firstTable) json.append(",\n");
                    firstTable = false;
                    
                    String table = tableEntry.getKey();
                    json.append("      \"").append(table).append("\": {\n");
                    
                    boolean firstColumn = true;
                    for (Map.Entry<String, ColumnInfo> columnEntry : tableEntry.getValue().entrySet()) {
                        if (!firstColumn) json.append(",\n");
                        firstColumn = false;
                        
                        String column = columnEntry.getKey();
                        ColumnInfo info = columnEntry.getValue();
                        json.append("        \"").append(column).append("\": {\n");
                        json.append("          \"dataType\": \"").append(info.dataType).append("\",\n");
                        json.append("          \"dataLength\": ").append(info.dataLength).append(",\n");
                        json.append("          \"dataScale\": ").append(info.dataScale).append(",\n");
                        json.append("          \"sampleData\": \"").append(info.sampleData != null ? info.sampleData.replace("\"", "\\\"") : "").append("\"\n");
                        json.append("        }");
                    }
                    json.append("\n      }");
                }
                json.append("\n    }");
            }
            json.append("\n  }\n");
            json.append("}\n");
            
            // íŒŒì¼ ì €ì¥
            String fileName = "out/oracle_dictionary_" + System.currentTimeMillis() + ".json";
            Files.write(Paths.get(fileName), json.toString().getBytes());
            System.out.println("âœ“ ë”•ì…”ë„ˆë¦¬ íŒŒì¼ ì €ì¥: " + fileName);
            
        } catch (Exception e) {
            System.err.println("ë”•ì…”ë„ˆë¦¬ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + e.getMessage());
        }
    }
    
    private String getSampleData(String owner, String tableName, String columnName, String dataType) {
        // CLOB, BLOB ë“± ëŒ€ìš©ëŸ‰ ë°ì´í„°ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
        if (isLargeDataType(dataType)) {
            return generateDefaultValueForType(dataType);
        }
        
        try {
            String sql = String.format("""
                SET PAGESIZE 0
                SET FEEDBACK OFF
                SET HEADING OFF
                SELECT %s FROM %s.%s WHERE ROWNUM = 1;
                """, columnName, owner, tableName);
            
            String result = executeSqlPlus(sql);
            String[] lines = result.split("\n");
            
            for (String line : lines) {
                line = line.trim();
                if (!line.isEmpty() && !line.startsWith("SQL>") && !line.startsWith("Connected")) {
                    return line;
                }
            }
        } catch (Exception e) {
            // ìƒ˜í”Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
        }
        
        return generateDefaultValueForType(dataType);
    }
    
    private boolean isLargeDataType(String dataType) {
        return Arrays.asList("CLOB", "BLOB", "RAW", "LONG RAW", "BFILE", "XMLTYPE", "JSON")
                    .contains(dataType.toUpperCase());
    }
    
    private String generateDefaultValueForType(String dataType) {
        switch (dataType.toUpperCase()) {
            case "VARCHAR2":
            case "CHAR":
                return String.valueOf(FALLBACK_ID);
            case "CLOB":
                return "CLOB_DATA";
            case "BLOB":
                return "424C4F42"; // "BLOB"ì˜ HEX
            case "RAW":
            case "LONG RAW":
                return "52415744415441"; // "RAWDATA"ì˜ HEX
            case "BFILE":
                return "BFILE_PATH";
            case "NUMBER":
                return String.valueOf(FALLBACK_ID);
            case "DATE":
                return FALLBACK_DATE;
            case "TIMESTAMP":
                return FALLBACK_TIMESTAMP;
            case "XMLTYPE":
                return "XML_DATA";
            case "JSON":
                return "JSON_DATA";
            default:
                return "DEFAULT_VALUE";
        }
    }
    
    private void step3GetServiceUsers() {
        System.out.println("3ë‹¨ê³„: ì„œë¹„ìŠ¤ ìœ ì € ëª©ë¡ í™•ì¸...");
        String[] users = ORACLE_SVC_USER_LIST != null ? 
            ORACLE_SVC_USER_LIST.split(",") : new String[]{ORACLE_SVC_USER};
        System.out.println("âœ“ ì„œë¹„ìŠ¤ ìœ ì €: " + Arrays.toString(users));
    }
    
    private void step4ExtractBindVariables() throws Exception {
        System.out.println("4ë‹¨ê³„: ë°”ì¸ë“œ ë³€ìˆ˜ ì¶”ì¶œ ì¤‘...");
        
        String mapperFolder = SOURCE_SQL_MAPPER_FOLDER != null ? 
            SOURCE_SQL_MAPPER_FOLDER : "./mappers";
        
        Path mapperPath = Paths.get(mapperFolder);
        if (!Files.exists(mapperPath)) {
            throw new RuntimeException("ë§¤í¼ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + mapperFolder);
        }
        
        Pattern bindVarPattern = Pattern.compile("[#$]\\{([^}]+)\\}");
        
        Files.walk(mapperPath)
             .filter(path -> path.toString().endsWith(".xml") || path.toString().endsWith(".sql"))
             .forEach(path -> {
                 try {
                     String content = Files.readString(path);
                     Matcher matcher = bindVarPattern.matcher(content);
                     
                     while (matcher.find()) {
                         String varName = matcher.group(1).trim();
                         bindVariables.computeIfAbsent(varName, k -> new BindVariable(k))
                                     .addFile(path.toString());
                     }
                 } catch (IOException e) {
                     System.err.println("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ " + path + ": " + e.getMessage());
                 }
             });
        
        System.out.printf("âœ“ ë°”ì¸ë“œ ë³€ìˆ˜ ì¶”ì¶œ ì™„ë£Œ (%dê°œ)%n", bindVariables.size());
    }
    
    private void step5MatchBindVariables() {
        System.out.println("5ë‹¨ê³„: ë°”ì¸ë“œ ë³€ìˆ˜ ë§¤ì¹­ ë° ê°’ ìƒì„±...");
        
        int matchedCount = 0;
        
        for (BindVariable bindVar : bindVariables.values()) {
            if (bindVar.getValue() != null) continue; // ì´ë¯¸ ê°’ì´ ìˆìœ¼ë©´ ìŠ¤í‚µ
            
            // ë”•ì…”ë„ˆë¦¬ì—ì„œ ìœ ì‚¬í•œ ì»¬ëŸ¼ ì°¾ê¸°
            ColumnMatch match = findBestColumnMatch(bindVar.getName());
            if (match != null) {
                String value = generateValueForColumn(bindVar.getName(), match.columnInfo);
                bindVar.setValue(value);
                bindVar.setMatchedColumn(match.fullColumnName);
                matchedCount++;
            }
        }
        
        System.out.printf("âœ“ ìë™ ë§¤ì¹­ ì™„ë£Œ (%d/%dê°œ)%n", matchedCount, bindVariables.size());
    }
    
    private ColumnMatch findBestColumnMatch(String varName) {
        String varLower = varName.toLowerCase().replaceAll("[_-]", "");
        
        ColumnMatch bestMatch = null;
        int bestScore = 0;
        
        for (Map.Entry<String, Map<String, Map<String, ColumnInfo>>> schemaEntry : dictionary.entrySet()) {
            String schema = schemaEntry.getKey();
            
            for (Map.Entry<String, Map<String, ColumnInfo>> tableEntry : schemaEntry.getValue().entrySet()) {
                String table = tableEntry.getKey();
                
                for (Map.Entry<String, ColumnInfo> columnEntry : tableEntry.getValue().entrySet()) {
                    String column = columnEntry.getKey();
                    String colLower = column.toLowerCase().replaceAll("[_-]", "");
                    
                    int score = calculateSimilarityScore(varLower, colLower);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = new ColumnMatch(
                            schema + "." + table + "." + column,
                            columnEntry.getValue()
                        );
                    }
                }
            }
        }
        
        return bestScore >= SIMILARITY_THRESHOLD ? bestMatch : null; // ì„¤ì •ëœ ì„ê³„ê°’ ì´ìƒ ìœ ì‚¬ë„ë§Œ ë§¤ì¹­
    }
    
    private int calculateSimilarityScore(String var, String col) {
        if (var.equals(col)) return 100;
        if (var.contains(col) || col.contains(var)) return 80;
        
        // ê³µí†µ ë¶€ë¶„ ë¬¸ìì—´ ê³„ì‚°
        int commonLength = 0;
        int minLength = Math.min(var.length(), col.length());
        
        for (int i = 0; i < minLength; i++) {
            if (var.charAt(i) == col.charAt(i)) {
                commonLength++;
            } else {
                break;
            }
        }
        
        return (commonLength * 100) / Math.max(var.length(), col.length());
    }
    
    private String generateValueForColumn(String varName, ColumnInfo columnInfo) {
        String varLower = varName.toLowerCase();
        
        // ë³€ìˆ˜ëª… ê¸°ë°˜ íƒ€ì… íŒë‹¨
        if (isNumericVariable(varLower)) {
            return generateNumericValue(varLower);
        } else if (isDateVariable(varLower)) {
            if (varLower.contains("time") || varLower.endsWith("at")) {
                return FALLBACK_TIMESTAMP;
            } else {
                return FALLBACK_DATE;
            }
        } else {
            // ë¬¸ìì—´
            if (columnInfo.sampleData != null && !columnInfo.sampleData.equals("DEFAULT_VALUE")) {
                return cleanSampleData(columnInfo.sampleData);
            } else {
                return generateStringValue(varLower);
            }
        }
    }
    
    private String cleanSampleData(String sampleData) {
        // CLOB ê°ì²´ ì°¸ì¡° ì œê±°
        if (sampleData.contains("oracle.sql.CLOB@")) {
            return "CLOB_DATA";
        }
        // ê¸°íƒ€ íŠ¹ìˆ˜ ë¬¸ì ì œê±°
        return sampleData.replaceAll("[\\r\\n\\t]", " ").trim();
    }
    
    private boolean isNumericVariable(String varName) {
        return varName.endsWith("id") || varName.startsWith("id") ||
               varName.contains("count") || varName.contains("limit") || 
               varName.contains("offset") || varName.contains("amount") ||
               varName.contains("price") || varName.contains("spent") ||
               varName.contains("days") || varName.contains("score") ||
               varName.contains("weight") || varName.contains("probability") ||
               varName.contains("risk") || varName.equals("year");
    }
    
    private boolean isDateVariable(String varName) {
        return varName.contains("date") || varName.contains("time") ||
               varName.endsWith("at") || varName.equals("createdat") ||
               varName.equals("updatedat") || varName.equals("deletedat");
    }
    
    private String generateNumericValue(String varName) {
        // Q Chatì„ í†µí•´ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ê°’ ìƒì„± ì‹œë„
        try {
            QChatResult result = callQChatForValue(varName, "ìˆ«ì");
            if (result != null && result.value != null && isValidNumeric(result.value)) {
                return result.value;
            }
        } catch (Exception e) {
            System.out.printf("Q Chat ìˆ«ì ê°’ ìƒì„± ì‹¤íŒ¨ (%s): %s%n", varName, e.getMessage());
        }
        
        // Q Chat ì‹¤íŒ¨ì‹œ ìµœì†Œí•œì˜ fallback
        System.out.printf("Q Chat ì‹¤íŒ¨, fallback ê°’ ì‚¬ìš©: %s%n", varName);
        if (varName.contains("id")) return String.valueOf(FALLBACK_ID);
        if (varName.contains("offset")) return String.valueOf(FALLBACK_OFFSET);
        if (varName.contains("limit")) return String.valueOf(FALLBACK_LIMIT);
        if (varName.contains("amount") || varName.contains("price") || varName.contains("spent")) return String.valueOf(FALLBACK_AMOUNT);
        if (varName.contains("days")) return String.valueOf(FALLBACK_DAYS);
        if (varName.equals("year")) return FALLBACK_YEAR;
        return String.valueOf(FALLBACK_ID);
    }
    
    private String generateStringValue(String varName) {
        // Q Chatì„ í†µí•´ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ê°’ ìƒì„± ì‹œë„
        try {
            QChatResult result = callQChatForValue(varName, "ë¬¸ìì—´");
            if (result != null && result.value != null && !result.value.trim().isEmpty()) {
                return result.value;
            }
        } catch (Exception e) {
            System.out.printf("Q Chat ë¬¸ìì—´ ê°’ ìƒì„± ì‹¤íŒ¨ (%s): %s%n", varName, e.getMessage());
        }
        
        // Q Chat ì‹¤íŒ¨ì‹œ ìµœì†Œí•œì˜ fallback (ë³€ìˆ˜ëª… ê¸°ë°˜ ì¶”ë¡ )
        System.out.printf("Q Chat ì‹¤íŒ¨, fallback ê°’ ì‚¬ìš©: %s%n", varName);
        if (varName.contains("name")) return "TEST_" + varName.toUpperCase();
        if (varName.contains("status")) return "ACTIVE";
        if (varName.contains("email")) return "test@example.com";
        if (varName.contains("grade") || varName.contains("segment") || varName.contains("category")) return "VIP";
        if (varName.contains("keyword")) return "TEST";
        if (varName.contains("country")) return "USA";
        return "DEFAULT_" + varName.toUpperCase();
    }
    
    private void step6ManualMatching() {
        System.out.println("6ë‹¨ê³„: Q Chat ê¸°ë°˜ ì§€ëŠ¥í˜• ê°’ ìƒì„±...");
        
        List<BindVariable> unmatchedVars = new ArrayList<>();
        for (BindVariable var : bindVariables.values()) {
            if (var.getValue() == null) {
                unmatchedVars.add(var);
            }
        }
        
        if (unmatchedVars.isEmpty()) {
            System.out.println("âœ“ ëª¨ë“  ë³€ìˆ˜ê°€ ìë™ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }
        
        System.out.printf("Q Chat ì§€ëŠ¥í˜• ê°’ ìƒì„±ì´ í•„ìš”í•œ ë³€ìˆ˜: %dê°œ%n", unmatchedVars.size());
        
        int successCount = 0;
        int fallbackCount = 0;
        
        for (BindVariable bindVar : unmatchedVars) {
            System.out.printf("%n=== ë³€ìˆ˜: %s ===%n", bindVar.getName());
            
            try {
                // Q Chatì„ í†µí•œ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ê°’ ìƒì„±
                String dataType = determineDataType(bindVar.getName().toLowerCase());
                QChatResult result = callQChatForValue(bindVar.getName(), dataType);
                
                if (result != null && result.value != null && !result.value.trim().isEmpty()) {
                    String cleanValue = result.value.trim();
                    
                    // ê°’ ìœ íš¨ì„± ê²€ì¦
                    if (isValidValue(cleanValue, dataType)) {
                        bindVar.setValue(cleanValue);
                        if (result.matchedColumn != null) {
                            bindVar.setMatchedColumn(result.matchedColumn);
                            System.out.printf("âœ“ Q Chat ì„±ê³µ: %s (ë§¤ì¹­: %s)%n", cleanValue, result.matchedColumn);
                        } else {
                            System.out.printf("âœ“ Q Chat ì„±ê³µ: %s (ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜)%n", cleanValue);
                        }
                        successCount++;
                        continue;
                    }
                }
            } catch (Exception e) {
                System.out.printf("Q Chat ì‹¤í–‰ ì˜¤ë¥˜: %s%n", e.getMessage());
            }
            
            // Q Chat ì‹¤íŒ¨ì‹œ fallback ê°’ ì‚¬ìš©
            String fallbackValue = generateFallbackValue(bindVar.getName());
            bindVar.setValue(fallbackValue);
            System.out.printf("âœ“ Fallback ê°’ ì‚¬ìš©: %s%n", fallbackValue);
            fallbackCount++;
        }
        
        System.out.printf("%nâœ“ Q Chat ì§€ëŠ¥í˜• ê°’ ìƒì„± ì™„ë£Œ%n");
        System.out.printf("  - Q Chat ì„±ê³µ: %dê°œ%n", successCount);
        System.out.printf("  - Fallback ì‚¬ìš©: %dê°œ%n", fallbackCount);
        System.out.printf("  - ì„±ê³µë¥ : %.1f%%%n", successCount * 100.0 / unmatchedVars.size());
    }
    
    /**
     * ê°’ ìœ íš¨ì„± ê²€ì¦
     */
    private boolean isValidValue(String value, String dataType) {
        if (value == null || value.trim().isEmpty()) return false;
        
        switch (dataType) {
            case "ìˆ«ì":
                return isValidNumeric(value);
            case "ë‚ ì§œ":
                return isValidDate(value);
            case "ë¬¸ìì—´":
                return value.length() <= 255; // ì¼ë°˜ì ì¸ VARCHAR ê¸¸ì´ ì œí•œ
            default:
                return true;
        }
    }
    
    /**
     * ë‚ ì§œ ê°’ ìœ íš¨ì„± ê²€ì¦
     */
    private boolean isValidDate(String value) {
        try {
            // ê°„ë‹¨í•œ ë‚ ì§œ í˜•ì‹ ê²€ì¦
            return value.matches("\\d{4}-\\d{2}-\\d{2}") || 
                   value.matches("\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}");
        } catch (Exception e) {
            return false;
        }
    }
    
    /**
     * Fallback ê°’ ìƒì„± (Q Chat ì‹¤íŒ¨ì‹œ)
     */
    private String generateFallbackValue(String varName) {
        String varLower = varName.toLowerCase();
        
        if (isNumericVariable(varLower)) {
            if (varLower.contains("id")) return String.valueOf(FALLBACK_ID);
            if (varLower.contains("amount") || varLower.contains("price")) return String.valueOf(FALLBACK_AMOUNT);
            if (varLower.contains("days")) return String.valueOf(FALLBACK_DAYS);
            if (varLower.contains("limit")) return String.valueOf(FALLBACK_LIMIT);
            if (varLower.contains("offset")) return String.valueOf(FALLBACK_OFFSET);
            if (varLower.equals("year")) return FALLBACK_YEAR;
            return String.valueOf(FALLBACK_ID);
        } else if (isDateVariable(varLower)) {
            if (varLower.contains("time") || varLower.endsWith("at")) {
                return FALLBACK_TIMESTAMP;
            } else {
                return FALLBACK_DATE;
            }
        } else {
            // ë¬¸ìì—´ fallback
            if (varLower.contains("status")) return "ACTIVE";
            if (varLower.contains("email")) return "test@example.com";
            if (varLower.contains("name")) return "TEST_" + varName.toUpperCase();
            return "DEFAULT_" + varName.toUpperCase();
        }
    }
    
    private QChatResult callQChat(BindVariable bindVar) throws Exception {
        String prompt = generateQChatPrompt(bindVar);
        
        System.out.println("Q Chat ì‹¤í–‰ ì¤‘...");
        
        ProcessBuilder pb = new ProcessBuilder("q", "chat", "--no-interactive");
        pb.environment().put("Q_CHAT_TIMEOUT", String.valueOf(Q_CHAT_TIMEOUT));
        pb.environment().put("NO_COLOR", "1");
        pb.environment().put("TERM", "dumb");
        
        Process process = pb.start();
        
        try (PrintWriter writer = new PrintWriter(process.getOutputStream())) {
            writer.println(prompt);
            writer.flush();
        }
        
        StringBuilder output = new StringBuilder();
        StringBuilder error = new StringBuilder();
        
        // ì¶œë ¥ ì½ê¸°
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
        }
        
        // ì—ëŸ¬ ì½ê¸°
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getErrorStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                error.append(line).append("\n");
            }
        }
        
        boolean finished = process.waitFor(Q_CHAT_TIMEOUT, java.util.concurrent.TimeUnit.SECONDS);
        if (!finished) {
            process.destroyForcibly();
            throw new RuntimeException("Q Chat ì‹¤í–‰ ì‹œê°„ ì´ˆê³¼");
        }
        
        if (process.exitValue() != 0) {
            throw new RuntimeException("Q Chat ì‹¤í–‰ ì‹¤íŒ¨: " + error.toString());
        }
        
        return parseQChatResponse(output.toString(), bindVar.getName());
    }
    
    private String generateQChatPrompt(BindVariable bindVar) {
        StringBuilder prompt = new StringBuilder();
        
        prompt.append("ë°”ì¸ë“œ ë³€ìˆ˜ ë§¤ì¹­ ìš”ì²­:\n\n");
        prompt.append("ë³€ìˆ˜ëª…: ").append(bindVar.getName()).append("\n");
        prompt.append("ì‚¬ìš©ëœ íŒŒì¼: ").append(String.join(", ", bindVar.getFiles())).append("\n");
        prompt.append("ì»¨í…ìŠ¤íŠ¸: SQL ë§¤í¼ì—ì„œ ë°ì´í„° í•„í„°ë§/ì¡°íšŒ ìš©ë„ë¡œ ì‚¬ìš©\n\n");
        
        // ë™ì ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆ ì •ë³´ ìƒì„±
        String[] schemas = ORACLE_SVC_USER_LIST != null ? 
            ORACLE_SVC_USER_LIST.split(",") : new String[]{ORACLE_SVC_USER};
        
        prompt.append("Oracle DB ìŠ¤í‚¤ë§ˆ ì •ë³´:\n");
        for (String schema : schemas) {
            schema = schema.trim();
            if (dictionary.containsKey(schema)) {
                prompt.append("- ìŠ¤í‚¤ë§ˆ: ").append(schema).append("\n");
                // ì£¼ìš” í…Œì´ë¸”ë“¤ë§Œ ìƒ˜í”Œë¡œ í‘œì‹œ
                int tableCount = 0;
                for (String tableName : dictionary.get(schema).keySet()) {
                    if (tableCount < MAX_SAMPLE_TABLES) { // í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •ëœ ê°œìˆ˜ë§Œ í‘œì‹œ
                        prompt.append("  * ").append(tableName).append("\n");
                        tableCount++;
                    }
                }
                if (dictionary.get(schema).size() > MAX_SAMPLE_TABLES) {
                    prompt.append("  * ... ì´ ").append(dictionary.get(schema).size()).append("ê°œ í…Œì´ë¸”\n");
                }
            }
        }
        prompt.append("\n");
        
        prompt.append("ì´ ë°”ì¸ë“œ ë³€ìˆ˜ì™€ ê°€ì¥ ì í•©í•œ DB ì»¬ëŸ¼ì„ ì°¾ì•„ì„œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\n\n");
        prompt.append("1. ë§¤ì¹­ëœ ê²½ìš°: \"ê°’ (ë§¤ì¹­: ìŠ¤í‚¤ë§ˆ.í…Œì´ë¸”.ì»¬ëŸ¼)\"\n");
        prompt.append("   ì˜ˆì‹œ: \"'VIP' (ë§¤ì¹­: ").append(schemas[0].trim()).append(".USERS.USER_GRADE)\"\n");
        prompt.append("   ì˜ˆì‹œ: \"1000 (ë§¤ì¹­: ").append(schemas[0].trim()).append(".ORDERS.AMOUNT)\"\n\n");
        prompt.append("2. ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš°: \"ê°’\"\n");
        prompt.append("   ì˜ˆì‹œ: \"'DEFAULT_VALUE'\"\n");
        prompt.append("   ì˜ˆì‹œ: \"1\"\n\n");
        prompt.append("ë³€ìˆ˜ëª…ì˜ ì˜ë¯¸ë¥¼ ë¶„ì„í•˜ì—¬ ê°€ì¥ ë…¼ë¦¬ì ìœ¼ë¡œ ë§¤ì¹­ë˜ëŠ” ì»¬ëŸ¼ì„ ì„ íƒí•˜ê³ , ");
        prompt.append("í•´ë‹¹ ì»¬ëŸ¼ì˜ ë°ì´í„° íƒ€ì…ì— ë§ëŠ” ì ì ˆí•œ í…ŒìŠ¤íŠ¸ ê°’ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n");
        prompt.append("ìˆ«ìëŠ” ë”°ì˜´í‘œ ì—†ì´, ë¬¸ìì—´ì€ ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ì‘ë‹µí•´ì£¼ì„¸ìš”.");
        
        return prompt.toString();
    }
    
    private QChatResult parseQChatResponse(String response, String varName) {
        if (response == null || response.trim().isEmpty()) {
            return null;
        }
        
        // ANSI ìƒ‰ìƒ ì½”ë“œ ì œê±°
        String cleanResponse = response
            .replaceAll("\\u001B\\[[;\\d]*m", "")
            .replaceAll("\\u001B\\[[0-9;]*[a-zA-Z]", "")
            .trim();
        
        // ë¼ì¸ë³„ë¡œ ë¶„ë¦¬í•˜ì—¬ ë§ˆì§€ë§‰ ìœ íš¨í•œ ê°’ ì°¾ê¸°
        String[] lines = cleanResponse.split("\n");
        
        for (int i = lines.length - 1; i >= 0; i--) {
            String line = lines[i].trim();
            
            // ë¹ˆ ì¤„ì´ë‚˜ ì„¤ëª… ìŠ¤í‚µ
            if (line.isEmpty() || line.length() > 50) {
                continue;
            }
            
            // ìˆ«ì ê°’ (ë”°ì˜´í‘œ ì—†ìŒ)
            if (line.matches("^\\d+(\\.\\d+)?$")) {
                return new QChatResult(line, null);
            }
            
            // ë¬¸ìì—´/ë‚ ì§œ ê°’ (ë”°ì˜´í‘œ ìˆìŒ)
            if (line.matches("^'[^']*'$")) {
                return new QChatResult(line, null);
            }
            
            // ë”°ì˜´í‘œ ì—†ëŠ” ê°„ë‹¨í•œ ê°’ë„ í—ˆìš©
            if (line.matches("^[A-Za-z0-9_-]+$") && line.length() <= 20) {
                return new QChatResult(line, null);
            }
        }
        
        return null;
    }
                line.contains("ì»¬ëŸ¼") || 
                line.contains("ì œê³µëœ") || 
                line.contains("í™•ì¸") ||
                line.contains("ì´ëŠ”") ||
                line.contains("ì´ ì¤‘ì—ì„œ") ||
                line.length() > 50) {  // ë„ˆë¬´ ê¸´ ì„¤ëª… í…ìŠ¤íŠ¸ ì œì™¸
                continue;
            }
            
            // ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì§„ ê°’
            if (line.matches("^'[^']*'$")) {
                return new QChatResult(line, null);
            }
            
            // ìˆœìˆ˜ ìˆ«ì ê°’
            if (line.matches("^[0-9]+\\.?[0-9]*$")) {
                return new QChatResult(line, null);
            }
            
            // ë‹¨ì–´ í•˜ë‚˜ë§Œ ìˆëŠ” ê²½ìš° (ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°)
            if (line.matches("^[A-Z_]+$") && line.length() <= MAX_WORD_LENGTH) {
                return new QChatResult("'" + line + "'", null);
            }
        }
        
        // ì•„ë¬´ê²ƒë„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ë³¸ê°’ ìƒì„±
        System.out.printf("Q Chat ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©: %s%n", varName);
        return new QChatResult(generateDefaultValueByName(varName), null);
    }
    
    // Q Chat ê²°ê³¼ë¥¼ ë‹´ëŠ” ë‚´ë¶€ í´ë˜ìŠ¤
    static class QChatResult {
        String value;
        String matchedColumn;
        
        QChatResult(String value, String matchedColumn) {
            this.value = value;
            this.matchedColumn = matchedColumn;
        }
    }
    
    private String generateDefaultValueByName(String varName) {
        String varLower = varName.toLowerCase();
        
        // Q Chatì„ í†µí•œ ì§€ëŠ¥í˜• ê°’ ìƒì„± ì‹œë„
        try {
            String dataType = determineDataType(varLower);
            QChatResult result = callQChatForValue(varName, dataType);
            if (result != null && result.value != null) {
                return result.value;
            }
        } catch (Exception e) {
            System.out.printf("Q Chat ê°’ ìƒì„± ì‹¤íŒ¨ (%s): %s%n", varName, e.getMessage());
        }
        
        // Q Chat ì‹¤íŒ¨ì‹œ íƒ€ì…ë³„ fallback
        if (isNumericVariable(varLower)) {
            return generateNumericValue(varLower);
        } else if (isDateVariable(varLower)) {
            if (varLower.contains("time") || varLower.endsWith("at")) {
                return FALLBACK_TIMESTAMP;
            } else {
                return FALLBACK_DATE;
            }
        } else {
            return generateStringValue(varLower);
        }
    }
    
    /**
     * ë³€ìˆ˜ëª… ê¸°ë°˜ ë°ì´í„° íƒ€ì… ê²°ì •
     */
    private String determineDataType(String varName) {
        if (isNumericVariable(varName)) {
            return "ìˆ«ì";
        } else if (isDateVariable(varName)) {
            return "ë‚ ì§œ";
        } else {
            return "ë¬¸ìì—´";
        }
    }
    
    private void step7GeneratePropertiesFile() throws Exception {
        System.out.println("7ë‹¨ê³„: parameters.properties íŒŒì¼ ìƒì„±...");
        
        try (PrintWriter writer = new PrintWriter(new FileWriter("parameters.properties"))) {
            writer.println("# ë°”ì¸ë“œ ë³€ìˆ˜ ë§¤ê°œë³€ìˆ˜ íŒŒì¼");
            writer.println("# ìƒì„±ì¼ì‹œ: " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
            writer.println();
            
            // ë³€ìˆ˜ëª… ìˆœìœ¼ë¡œ ì •ë ¬
            List<String> sortedVarNames = new ArrayList<>(bindVariables.keySet());
            Collections.sort(sortedVarNames);
            
            for (String varName : sortedVarNames) {
                BindVariable bindVar = bindVariables.get(varName);
                String comment = "";
                
                if (bindVar.getMatchedColumn() != null) {
                    // ë§¤ì¹­ëœ ì»¬ëŸ¼ ì •ë³´ëŠ” ë‚¨ê¸°ê³  '- ë§¤ì¹­ëœ ì»¬ëŸ¼' í…ìŠ¤íŠ¸ë§Œ ì œê±°
                    comment = "# " + bindVar.getMatchedColumn();
                } else {
                    comment = "# ë§¤ì¹­ ì—†ìŒ";
                }
                
                // ê°’ í¬ë§·íŒ… - ë°ì´í„° íƒ€ì…ì— ë§ê²Œ ë”°ì˜´í‘œ ì²˜ë¦¬
                String formattedValue = formatValueForProperties(bindVar.getValue(), varName);
                
                writer.println(comment);
                writer.println(varName + "=" + formattedValue);
                writer.println();
            }
        }
        
        System.out.printf("âœ“ parameters.properties íŒŒì¼ ìƒì„± ì™„ë£Œ (%dê°œ ë³€ìˆ˜)%n", bindVariables.size());
    }
    
    /**
     * parameters.properties íŒŒì¼ìš© ê°’ í¬ë§·íŒ…
     * ìˆ«ìëŠ” ë”°ì˜´í‘œ ì—†ì´, ë¬¸ìì—´ê³¼ ë‚ ì§œëŠ” ë”°ì˜´í‘œ ìˆê²Œ
     */
    private String formatValueForProperties(String value, String varName) {
        if (value == null) {
            return "";
        }
        
        String cleanValue = value.trim();
        
        // ì´ë¯¸ ë”°ì˜´í‘œë¡œ ê°ì‹¸ì ¸ ìˆìœ¼ë©´ ì œê±°
        if (cleanValue.startsWith("'") && cleanValue.endsWith("'")) {
            cleanValue = cleanValue.substring(1, cleanValue.length() - 1);
        }
        
        String varLower = varName.toLowerCase();
        
        // ìˆ«ì íƒ€ì… ë³€ìˆ˜ëŠ” ë”°ì˜´í‘œ ì—†ì´
        if (isNumericVariable(varLower)) {
            return cleanValue;
        }
        
        // ë¬¸ìì—´ê³¼ ë‚ ì§œëŠ” ë”°ì˜´í‘œ ìˆê²Œ
        return "'" + cleanValue + "'";
    }
    
    /**
     * Q Chatì„ í†µí•œ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ê°’ ìƒì„± (ë¹ ë¥¸ ì‘ë‹µ ìµœì í™”)
     */
    private QChatResult callQChatForValue(String varName, String dataType) throws Exception {
        StringBuilder prompt = new StringBuilder();
        
        // ë°”ì¸ë“œ ë³€ìˆ˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        BindVariable bindVar = bindVariables.get(varName);
        if (bindVar == null) {
            throw new Exception("ë°”ì¸ë“œ ë³€ìˆ˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + varName);
        }
        
        // ê°„ê²°í•œ í”„ë¡¬í”„íŠ¸ (ë¹ ë¥¸ ì‘ë‹µ ìµœì í™”)
        prompt.append("SQL ë°”ì¸ë“œ ë³€ìˆ˜ ê°’ ìƒì„±:\n");
        prompt.append("ë³€ìˆ˜: #{").append(varName).append("}\n");
        
        // SQL ì»¨í…ìŠ¤íŠ¸ (í•µì‹¬ë§Œ)
        if (!bindVar.getFiles().isEmpty()) {
            String xmlFile = bindVar.getFiles().iterator().next();
            String sqlContext = extractSqlContextBrief(xmlFile, varName);
            if (sqlContext != null && !sqlContext.trim().isEmpty()) {
                prompt.append("SQL: ").append(sqlContext).append("\n");
            }
        }
        
        // ê°„ë‹¨í•œ ìš”ì²­
        if (dataType.equals("ìˆ«ì")) {
            prompt.append("ìˆ«ì ê°’ë§Œ ë°˜í™˜ (ì˜ˆ: 1, 100, 2025)");
        } else if (dataType.equals("ë‚ ì§œ")) {
            prompt.append("ë‚ ì§œ ê°’ì„ ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ë°˜í™˜ (ì˜ˆ: '2025-08-24')");
        } else {
            prompt.append("ë¬¸ìì—´ ê°’ì„ ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ë°˜í™˜ (ì˜ˆ: 'ACTIVE')");
        }
        
        return callQChatWithPrompt(prompt.toString(), varName);
    }
    
    /**
     * ê°„ê²°í•œ SQL ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ (ë¹ ë¥¸ ì‘ë‹µìš©)
     */
    private String extractSqlContextBrief(String xmlFile, String varName) {
        try {
            StringBuilder content = new StringBuilder();
            try (BufferedReader reader = new BufferedReader(new FileReader(xmlFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    content.append(line).append("\n");
                }
            }
            
            String xmlContent = content.toString();
            String[] lines = xmlContent.split("\n");
            
            for (int i = 0; i < lines.length; i++) {
                String line = lines[i].trim();
                
                // ë°”ì¸ë“œ ë³€ìˆ˜ê°€ í¬í•¨ëœ ë¼ì¸ ì°¾ê¸°
                if (line.contains("#{" + varName + "}") || line.contains("${" + varName + "}")) {
                    // í•´ë‹¹ ë¼ì¸ë§Œ ê°„ë‹¨íˆ ë°˜í™˜
                    return line.replaceAll("\\s+", " ").trim();
                }
            }
            
        } catch (Exception e) {
            // ë¬´ì‹œí•˜ê³  ê³„ì†
        }
        
        return null;
    }
    
    /**
     * ë§¤í¼ íŒŒì¼ì—ì„œ SQL ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ
     */
    private String extractSqlContext(String xmlFile, String varName) {
        try {
            // XML íŒŒì¼ ì½ê¸°
            StringBuilder content = new StringBuilder();
            try (BufferedReader reader = new BufferedReader(new FileReader(xmlFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    content.append(line).append("\n");
                }
            }
            
            String xmlContent = content.toString();
            
            // #{varName} ë˜ëŠ” ${varName}ì´ í¬í•¨ëœ SQL ë¸”ë¡ ì°¾ê¸°
            String[] lines = xmlContent.split("\n");
            List<String> contextLines = new ArrayList<>();
            boolean inRelevantSql = false;
            String currentSqlId = null;
            
            for (int i = 0; i < lines.length; i++) {
                String line = lines[i].trim();
                
                // SQL ì‹œì‘ íƒœê·¸ ì°¾ê¸°
                if (line.contains("<select") || line.contains("<insert") || 
                    line.contains("<update") || line.contains("<delete")) {
                    // id ì†ì„± ì¶”ì¶œ
                    if (line.contains("id=\"")) {
                        int start = line.indexOf("id=\"") + 4;
                        int end = line.indexOf("\"", start);
                        if (end > start) {
                            currentSqlId = line.substring(start, end);
                        }
                    }
                    inRelevantSql = false;
                    contextLines.clear();
                }
                
                // í˜„ì¬ ë¼ì¸ì— ë°”ì¸ë“œ ë³€ìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (line.contains("#{" + varName + "}") || line.contains("${" + varName + "}")) {
                    inRelevantSql = true;
                    
                    // ì•ë’¤ ì»¨í…ìŠ¤íŠ¸ ë¼ì¸ë“¤ ìˆ˜ì§‘
                    int startLine = Math.max(0, i - 5);
                    int endLine = Math.min(lines.length - 1, i + 5);
                    
                    contextLines.clear();
                    if (currentSqlId != null) {
                        contextLines.add("-- SQL ID: " + currentSqlId);
                        contextLines.add("-- ë¼ì¸ " + (i + 1) + "ì—ì„œ #{" + varName + "} ë°œê²¬");
                        contextLines.add("");
                    }
                    
                    for (int j = startLine; j <= endLine; j++) {
                        String contextLine = lines[j].trim();
                        if (!contextLine.isEmpty() && 
                            !contextLine.startsWith("<!--") && 
                            !contextLine.startsWith("-->") &&
                            !contextLine.startsWith("<") && 
                            !contextLine.endsWith(">")) {
                            
                            // ë°”ì¸ë“œ ë³€ìˆ˜ê°€ ìˆëŠ” ë¼ì¸ ê°•ì¡°
                            if (j == i) {
                                contextLines.add(">>> " + contextLine + " <<<");
                            } else {
                                contextLines.add("    " + contextLine);
                            }
                        }
                    }
                    break;
                }
            }
            
            if (!contextLines.isEmpty()) {
                return String.join("\n", contextLines);
            }
            
        } catch (Exception e) {
            System.out.printf("SQL ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨ (%s): %s%n", xmlFile, e.getMessage());
        }
        
        return null;
    }
    
    /**
     * í…Œì´ë¸”ì´ ë³€ìˆ˜ì™€ ê´€ë ¨ìˆëŠ”ì§€ í™•ì¸
     */
    private boolean isTableRelevant(String tableName, String varName) {
        String tableNameLower = tableName.toLowerCase();
        String varNameLower = varName.toLowerCase();
        
        // ì§ì ‘ ë§¤ì¹­
        if (varNameLower.contains(tableNameLower) || tableNameLower.contains(varNameLower)) {
            return true;
        }
        
        // ì˜ë¯¸ì  ë§¤ì¹­
        if (varNameLower.contains("user") && tableNameLower.contains("user")) return true;
        if (varNameLower.contains("order") && tableNameLower.contains("order")) return true;
        if (varNameLower.contains("product") && tableNameLower.contains("product")) return true;
        if (varNameLower.contains("payment") && tableNameLower.contains("payment")) return true;
        if (varNameLower.contains("seller") && tableNameLower.contains("seller")) return true;
        
        return false;
    }
    
    /**
     * ë³€ìˆ˜ëª…ê³¼ ì»¬ëŸ¼ëª…ì˜ ê´€ë ¨ì„± í™•ì¸
     */
    private boolean isRelatedColumn(String varName, String columnName) {
        String varLower = varName.toLowerCase();
        String colLower = columnName.toLowerCase();
        
        // ì§ì ‘ ë§¤ì¹­
        if (varLower.equals(colLower)) return true;
        
        // ë¶€ë¶„ ë§¤ì¹­
        if (varLower.contains(colLower) || colLower.contains(varLower)) return true;
        
        // ì˜ë¯¸ì  ë§¤ì¹­
        if (varLower.contains("id") && colLower.contains("id")) return true;
        if (varLower.contains("name") && colLower.contains("name")) return true;
        if (varLower.contains("status") && colLower.contains("status")) return true;
        if (varLower.contains("amount") && colLower.contains("amount")) return true;
        if (varLower.contains("date") && colLower.contains("date")) return true;
        if (varLower.contains("email") && colLower.contains("email")) return true;
        
        return false;
    }
    
    /**
     * Q Chat í˜¸ì¶œ (í”„ë¡¬í”„íŠ¸ ê¸°ë°˜)
     */
    private QChatResult callQChatWithPrompt(String prompt, String varName) throws Exception {
        System.out.println("=".repeat(80));
        System.out.printf("ğŸ¤– Q Chat í”„ë¡¬í”„íŠ¸ (ë³€ìˆ˜: %s):%n", varName);
        System.out.println("=".repeat(80));
        System.out.println(prompt);
        System.out.println("=".repeat(80));
        
        ProcessBuilder pb = new ProcessBuilder("q", "chat", prompt);
        pb.environment().put("Q_CHAT_TIMEOUT", String.valueOf(Q_CHAT_TIMEOUT));
        
        Process process = pb.start();
        
        StringBuilder output = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
        }
        
        boolean finished = process.waitFor(Q_CHAT_TIMEOUT, TimeUnit.SECONDS);
        if (!finished) {
            process.destroyForcibly();
            throw new Exception("Q Chat íƒ€ì„ì•„ì›ƒ");
        }
        
        if (process.exitValue() != 0) {
            throw new Exception("Q Chat ì‹¤í–‰ ì‹¤íŒ¨");
        }
        
        String response = output.toString();
        System.out.printf("ğŸ¤– Q Chat ì‘ë‹µ (ë³€ìˆ˜: %s):%n", varName);
        System.out.println("-".repeat(40));
        System.out.println(response);
        System.out.println("-".repeat(40));
        
        return parseQChatResponse(response, varName);
    }
    
    /**
     * ìˆ«ì ê°’ ìœ íš¨ì„± ê²€ì¦
     */
    private boolean isValidNumeric(String value) {
        if (value == null || value.trim().isEmpty()) return false;
        try {
            Double.parseDouble(value.trim());
            return true;
        } catch (NumberFormatException e) {
            return false;
        }
    }
    
    /**
     * ì•ˆì „í•œ ì •ìˆ˜ íŒŒì‹± (SYSASM ê°™ì€ ì‹œìŠ¤í…œ ê°’ ë¬´ì‹œ)
     */
    private int parseIntSafely(String str, int defaultValue) {
        if (str == null || str.trim().isEmpty()) {
            return defaultValue;
        }
        
        String trimmed = str.trim();
        
        // Oracle ì‹œìŠ¤í…œ ê°’ë“¤ ë¬´ì‹œ
        if (trimmed.equalsIgnoreCase("SYSASM") || 
            trimmed.equalsIgnoreCase("SYSDBA") || 
            trimmed.equalsIgnoreCase("SYSOPER") ||
            trimmed.equalsIgnoreCase("NULL") ||
            trimmed.equals("-")) {
            return defaultValue;
        }
        
        try {
            return Integer.parseInt(trimmed);
        } catch (NumberFormatException e) {
            // íŒŒì‹± ì‹¤íŒ¨ì‹œ ê¸°ë³¸ê°’ ë°˜í™˜
            return defaultValue;
        }
    }
    
    // ë‚´ë¶€ í´ë˜ìŠ¤ë“¤
    static class ColumnInfo {
        String dataType;
        int dataLength;
        int dataPrecision;
        int dataScale;
        String sampleData;
        
        ColumnInfo(String dataType, int dataLength, int dataPrecision, int dataScale, String sampleData) {
            this.dataType = dataType;
            this.dataLength = dataLength;
            this.dataPrecision = dataPrecision;
            this.dataScale = dataScale;
            this.sampleData = sampleData;
        }
    }
    
    static class BindVariable {
        private String name;
        private List<String> files = new ArrayList<>();
        private String value;
        private String matchedColumn;
        
        BindVariable(String name) {
            this.name = name;
        }
        
        void addFile(String file) {
            if (!files.contains(file)) {
                files.add(file);
            }
        }
        
        // Getters and Setters
        String getName() { return name; }
        List<String> getFiles() { return files; }
        String getValue() { return value; }
        void setValue(String value) { this.value = value; }
        String getMatchedColumn() { return matchedColumn; }
        void setMatchedColumn(String matchedColumn) { this.matchedColumn = matchedColumn; }
    }
    
    static class ColumnMatch {
        String fullColumnName;
        ColumnInfo columnInfo;
        
        ColumnMatch(String fullColumnName, ColumnInfo columnInfo) {
            this.fullColumnName = fullColumnName;
            this.columnInfo = columnInfo;
        }
    }
}
